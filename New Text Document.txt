import React, { useState } from 'react';
import {
  Row,
  Col,
  Card,
  Button,
  Table,
  Typography,
  Divider,
  Tag,
  Input,
  message,
  Modal,
  Flex,
  theme,
  Drawer,
  Badge,
  Space,
  Alert,
} from 'antd';
import {
  DeleteOutlined,
  CreditCardOutlined,
  DollarOutlined,
  SaveOutlined,
  UserOutlined,
  TableOutlined,
  ShoppingOutlined,
  WalletOutlined,
  CreditCardFilled,
  MobileOutlined,
  CloseCircleOutlined,
} from '@ant-design/icons';

const { Title, Text } = Typography;

// Sample data
const categories = [
  { id: 1, name: 'Fast Food', color: '#ff4d4f', icon: 'ðŸ”' },
  { id: 2, name: 'Biryani', color: '#52c41a', icon: 'ðŸ›' },
  { id: 3, name: 'Chinese', color: '#1890ff', icon: 'ðŸ¥¡' },
  { id: 4, name: 'Beverages', color: '#faad14', icon: 'ðŸ¥¤' },
  { id: 5, name: 'Desserts', color: '#eb2f96', icon: 'ðŸ°' },
  { id: 6, name: 'BBQ', color: '#722ed1', icon: 'ðŸ—' },
];

const products = [
  { id: 1, name: 'Chicken Biryani', price: 350, category: 2, image: 'ðŸ›' },
  { id: 2, name: 'Mutton Biryani', price: 450, category: 2, image: 'ðŸ›' },
  { id: 3, name: 'Zinger Burger', price: 250, category: 1, image: 'ðŸ”' },
  { id: 4, name: 'Chicken Burger', price: 200, category: 1, image: 'ðŸ”' },
  { id: 5, name: 'Beef Burger', price: 280, category: 1, image: 'ðŸ”' },
  { id: 6, name: 'Chicken Chow Mein', price: 300, category: 3, image: 'ðŸ¥¡' },
  { id: 7, name: 'Fried Rice', price: 250, category: 3, image: 'ðŸ¥¡' },
  { id: 8, name: 'Spring Rolls', price: 150, category: 3, image: 'ðŸ¥¡' },
  { id: 9, name: 'Coca Cola', price: 80, category: 4, image: 'ðŸ¥¤' },
  { id: 10, name: 'Pepsi', price: 80, category: 4, image: 'ðŸ¥¤' },
  { id: 11, name: 'Fresh Juice', price: 150, category: 4, image: 'ðŸ¥¤' },
  { id: 12, name: 'Chocolate Cake', price: 200, category: 5, image: 'ðŸ°' },
  { id: 13, name: 'Ice Cream', price: 120, category: 5, image: 'ðŸ°' },
  { id: 14, name: 'BBQ Chicken', price: 400, category: 6, image: 'ðŸ—' },
  { id: 15, name: 'Seekh Kabab', price: 350, category: 6, image: 'ðŸ—' },
];

const Dashboard = ({ onOpenTableBooking, selectedTable, onClearTable }) => {
  const [selectedCategory, setSelectedCategory] = useState(null);
  const [cart, setCart] = useState([]);
  const [calculatorDisplay, setCalculatorDisplay] = useState('');
  const [discountFocused, setDiscountFocused] = useState(false);
  const [discount, setDiscount] = useState('0');
  const [showPaymentModal, setShowPaymentModal] = useState(false);
  const [paymentMethod, setPaymentMethod] = useState('cash');
  const [receivedAmount, setReceivedAmount] = useState('0');
  const [customerType, setCustomerType] = useState('walking');
  const [cartDrawerVisible, setCartDrawerVisible] = useState(false);

  const {
    token: { colorBgContainer, borderRadiusLG },
  } = theme.useToken();

  // Filter products by category
  const filteredProducts = products.filter((product) =>
    selectedCategory ? product.category === selectedCategory : true
  );

  // Calculator button click
  const handleCalculatorClick = (value) => {
    if (discountFocused) {
      if (value === 'C') {
        setDiscount('0');
      } else if (value === 'âŒ«') {
        setDiscount(discount.length > 1 ? discount.slice(0, -1) : '0');
      } else {
        setDiscount(discount === '0' ? value : discount + value);
      }
    } else {
      if (value === 'C') {
        setCalculatorDisplay('');
      } else if (value === 'âŒ«') {
        setCalculatorDisplay(calculatorDisplay.slice(0, -1));
      } else {
        setCalculatorDisplay(calculatorDisplay + value);
      }
    }
  };

  // Handle product click
  const handleProductClick = (product) => {
    const quantity = parseInt(calculatorDisplay) || 1;
    const existingItem = cart.find((item) => item.id === product.id);
    
    if (existingItem) {
      setCart(
        cart.map((item) =>
          item.id === product.id
            ? { ...item, quantity: item.quantity + quantity }
            : item
        )
      );
    } else {
      setCart([...cart, { ...product, quantity }]);
    }
    
    message.success(`${quantity} x ${product.name} added to cart`);
    setCalculatorDisplay('');
  };

  // Remove from cart
  const removeFromCart = (id) => {
    setCart(cart.filter((item) => item.id !== id));
    message.info('Item removed from cart');
  };

  // Calculate totals
  const subtotal = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
  const discountAmount = parseFloat(discount) || 0;
  const tax = (subtotal - discountAmount) * 0.05;
  const total = subtotal - discountAmount + tax;
  const change = parseFloat(receivedAmount) - total;

  

  

  // Handle Save to Database
  const handleSaveOrder = () => {
    if (cart.length === 0) {
      message.warning('Cart is empty!');
      return;
    }

    // Here you would save to database
    const orderData = {
      items: cart,
      subtotal,
      discount: discountAmount,
      tax,
      total,
      customerType,
      tableNumber: selectedTable ? selectedTable.number : null,
      tableCapacity: selectedTable ? selectedTable.capacity : null,
      timestamp: new Date().toISOString(),
    };

    console.log('Saving order to database:', orderData);
    
    // Simulate database save
    message.success('Order saved successfully!');
    
    // Clear cart after save
    setCart([]);
    setDiscount('0');
    setCalculatorDisplay('');
    setDiscountFocused(false);
  };

  // Handle Table Customer Click
  const handleTableCustomer = () => {
    setCustomerType('table');
    onOpenTableBooking();
  };

  // Desktop Cart columns
  const desktopColumns = [
    {
      title: 'Item',
      dataIndex: 'name',
      key: 'name',
      render: (text, record) => (
        <Space size="small">
          <span style={{ fontSize: 20 }}>{record.image}</span>
        </Space>
      ),
    },
    {
      title: 'Qty',
      dataIndex: 'quantity',
      key: 'quantity',
      align: 'center',
      width: 50,
    },
    {
      title: 'Price',
      dataIndex: 'price',
      key: 'price',
      width: 70,
      render: (price) => <Text style={{ fontSize: 12 }}>Rs. {price}</Text>,
    },
    {
      title: 'Total',
      key: 'total',
      width: 80,
      render: (_, record) => <Text strong style={{ fontSize: 12 }}>Rs. {record.price * record.quantity}</Text>,
    },
    {
      title: '',
      key: 'action',
      width: 50,
      render: (_, record) => (
        <Button
          danger
          type="text"
          size="small"
          icon={<DeleteOutlined />}
          onClick={() => removeFromCart(record.id)}
        />
      ),
    },
  ];

  // Mobile Cart columns
  const mobileColumns = [
    {
      title: 'Item',
      dataIndex: 'name',
      key: 'name',
      render: (text, record) => (
        <Space direction="vertical" size={10}>
          <Space size="small">
            <span>{record.image}</span>
          </Space>
          <Space size="small">
            <Text type="secondary" style={{ fontSize: 12 }}>Qty: {record.quantity}</Text>
            <Text type="secondary" style={{ fontSize: 12 }}>@Rs. {record.price}</Text>
          </Space>
        </Space>
      ),
    },
    {
      title: 'Total',
      key: 'total',
      width: 80,
      align: 'right',
      render: (_, record) => (
        <Text strong style={{ fontSize: 14 }}>Rs. {record.price * record.quantity}</Text>
      ),
    },
    {
      title: '',
      key: 'action',
      width: 50,
      render: (_, record) => (
        <Button
          danger
          type="text"
          size="small"
          icon={<DeleteOutlined />}
          onClick={() => removeFromCart(record.id)}
        />
      ),
    },
  ];

  // Calculator Component
  const CalculatorComponent = ({ isModal = false }) => (
    <Card
      bordered={false}
      bodyStyle={{ padding: 8 }}
    >
      <Flex
        align="center"
        justify="flex-end"
        style={{
          background: '#001529',
          color: '#52c41a',
          padding: 10,
          borderRadius: 8,
          fontSize: isModal ? 20 : 18,
          fontWeight: 'bold',
          fontFamily: 'monospace',
          height: isModal ? 45 : 42,
          marginBottom: 6,
        }}
      >
        {discountFocused ? `Disc: ${discount}` : (calculatorDisplay || '0')}
      </Flex>

      <Row gutter={[4, 4]}>
        {['1', '2', '3', '4', '5', '6', '7', '8', '9', 'C', '0', 'âŒ«'].map((btn) => (
          <Col span={8} key={btn}>
            <Button
              block
              size="middle"
              onClick={() => handleCalculatorClick(btn)}
              style={{
                height: isModal ? 32 : 30,
                fontSize: isModal ? 18 : 16,
                fontWeight: 'bold',
                background: btn === 'C' ? '#ff4d4f' : btn === 'âŒ«' ? '#faad14' : undefined,
                borderColor: btn === 'C' ? '#ff4d4f' : btn === 'âŒ«' ? '#faad14' : undefined,
                color: btn === 'C' || btn === 'âŒ«' ? 'white' : undefined,
              }}
            >
              {btn}
            </Button>
          </Col>
        ))}
      </Row>
    </Card>
  );

  // Billing Summary Component
  const BillingSummary = ({ isModal = false }) => (
 <Card
  bordered={false}
  style={{
    background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
    height: isModal ? 'auto' : 195, // â— SAME HEIGHT
  }}
  headStyle={{ borderBottom: '1px solid rgba(255,255,255,0.2)' }}
  bodyStyle={{ padding: isModal ? 16 : 8 }} // ðŸ”½ padding reduced
>
  <Space direction="vertical" size={6} style={{ width: '100%' }}>

    <Flex justify="flex-end">
      <Text strong style={{ color: 'white', fontSize: 15 }}>
        Rs. {subtotal.toFixed(2)}
      </Text>
    </Flex>

    <Flex justify="flex-end">
      <Flex
        align="center"
        justify="flex-end"
        onClick={() => setDiscountFocused(!discountFocused)}
        style={{
          width: 95,
          fontWeight: 'bold',
          fontSize: 13,
          background: discountFocused ? '#fffbe6' : 'white',
          border: discountFocused ? '2px solid #faad14' : '1px solid #d9d9d9',
          borderRadius: 4,
          padding: '3px 8px', // ðŸ”½ compact
          cursor: 'pointer',
        }}
      >
        Rs. {discount}
      </Flex>
    </Flex>

    <Divider
      style={{
        borderColor: 'rgba(255,255,255,0.3)',
        margin: '2px 0', // ðŸ”½ very small
      }}
    />

    <Flex justify="flex-end">
      <Text strong style={{ color: 'white', fontSize: 22 }}>
        Rs. {total.toFixed(2)}
      </Text>
    </Flex>

    <Button
      type="primary"
      block
      size="small"
      icon={<SaveOutlined />}
      onClick={handleSaveOrder}
      disabled={cart.length === 0}
      style={{
        height: 30,
        background: '#106314',
        borderColor: '#106314',
      }}
    >
      Save
    </Button>

  </Space>
</Card>

  );

  return (
    <>
      <div style={{ minHeight: '100vh', padding: 16, background: '#f0f2f5' }}>
        {/* Table Number Display */}
        {selectedTable && (
          <Alert
            message={
              <Space>
                <TableOutlined style={{ fontSize: 18 }} />
                <Text strong style={{ fontSize: 16 }}>
                  Table {selectedTable.number} (Capacity: {selectedTable.capacity} persons)
                </Text>
              </Space>
            }
            type="success"
            closable
            onClose={() => {
              if (onClearTable) {
                onClearTable();
              }
              setCustomerType('walking');
            }}
            style={{ 
              marginBottom: 16,
              fontSize: 16,
              padding: '12px 16px'
            }}
            icon={<TableOutlined />}
            closeIcon={<CloseCircleOutlined />}
          />
        )}

        <Row gutter={[16, 16]} align="top">
          {/* Left Column - Products & Categories */}
          <Col xs={24} lg={16}>
            <Space direction="vertical" size={16} style={{ width: '100%' }}>
              {/* Products Section */}
              <Card
                style={{
                  height: 310,
                }}
                bodyStyle={{
                  height: 'calc(100% - 57px)',
                  padding: 12,
                  overflowY: 'auto',
                }}
              >
                <Row gutter={[8, 8]}>
                  {filteredProducts.map((product) => (
                    <Col
                      xs={12}
                      sm={8}
                      md={6}
                      lg={6}
                      xl={4}
                      key={product.id}
                    >
                      <Card
                        hoverable
                        onClick={() => handleProductClick(product)}
                        bodyStyle={{
                          padding: 12,
                          textAlign: 'center',
                        }}
                      >
                        <Space
                          direction="vertical"
                          size="small"
                          align="center"
                          style={{ width: '100%' }}
                        >
                          <span style={{ fontSize: 32 }}>
                            {product.image}
                          </span>

                          <Text
                            strong
                            style={{
                              fontSize: 12,
                              textAlign: 'center',
                              whiteSpace: 'normal',
                            }}
                          >
                            {product.name}
                          </Text>

                          <Tag color="blue">
                            Rs. {product.price}
                          </Tag>
                        </Space>
                      </Card>
                    </Col>
                  ))}
                </Row>
              </Card>

              {/* Categories Section */}
              <Card>
                <Row gutter={[8, 8]}>
                  <Col xs={8} sm={6} md={4} lg={3}>
                    <Button
                      type={!selectedCategory ? 'primary' : 'default'}
                      block
                      size="large"
                      onClick={() => setSelectedCategory(null)}
                      style={{ height: 60 }}
                    >
                      <Space direction="vertical" size={1} align="center">
                        <span style={{ fontSize: 20 }}>ðŸ“‹</span>
                        <Text strong style={{ fontSize: 9, color: !selectedCategory ? 'white' : undefined }}>
                          All Items
                        </Text>
                      </Space>
                    </Button>
                  </Col>
                  {categories.map((category) => (
                    <Col xs={8} sm={6} md={4} lg={3} key={category.id}>
                      <Button
                        type={selectedCategory === category.id ? 'primary' : 'default'}
                        block
                        size="large"
                        onClick={() => setSelectedCategory(category.id)}
                        style={{
                          height: 60,
                          backgroundColor: selectedCategory === category.id ? undefined : category.color,
                          borderColor: selectedCategory === category.id ? undefined : category.color,
                        }}
                      >
                        <Space direction="vertical" size={1} align="center">
                          <span style={{ fontSize: 20 }}>{category.icon}</span>
                          <Text
                            strong
                            style={{
                              fontSize: 9,
                              color: selectedCategory === category.id ? 'white' : undefined,
                            }}
                          >
                            {category.name}
                          </Text>
                        </Space>
                      </Button>
                    </Col>
                  ))}
                </Row>
              </Card>

              {/* Customer Type Buttons */}
              <Row gutter={[8, 8]}>
                <Col xs={24} sm={8}>
                  <Button
                    type={customerType === 'walking' ? 'primary' : 'default'}
                    block
                    size="large"
                    icon={<UserOutlined />}
                    onClick={() => {
                      setCustomerType('walking');
                      if (onClearTable) {
                        onClearTable();
                      }
                    }}
                    style={{
                      height: 48,
                      fontSize: 14,
                      fontWeight: 'bold',
                      background: customerType === 'walking' ? '#1890ff' : undefined,
                      borderColor: customerType === 'walking' ? '#1890ff' : undefined,
                    }}
                  >
                    Walking Customer
                  </Button>
                </Col>
                <Col xs={24} sm={8}>
                  <Button
                    type={customerType === 'table' || selectedTable ? 'primary' : 'default'}
                    block
                    size="large"
                    icon={<TableOutlined />}
                    onClick={handleTableCustomer}
                    style={{
                      height: 48,
                      fontSize: 14,
                      fontWeight: 'bold',
                      background: (customerType === 'table' || selectedTable) ? '#52c41a' : undefined,
                      borderColor: (customerType === 'table' || selectedTable) ? '#52c41a' : undefined,
                    }}
                  >
                    {selectedTable ? `Table ${selectedTable.number}` : 'Table Customer'}
                  </Button>
                </Col>
                <Col xs={24} sm={8}>
                  <Button
                    type={customerType === 'order' ? 'primary' : 'default'}
                    block
                    size="large"
                    icon={<ShoppingOutlined />}
                    onClick={() => {
                      setCustomerType('order');
                      if (onClearTable) {
                        onClearTable();
                      }
                    }}
                    style={{
                      height: 48,
                      fontSize: 14,
                      fontWeight: 'bold',
                      background: customerType === 'order' ? '#faad14' : undefined,
                      borderColor: customerType === 'order' ? '#faad14' : undefined,
                    }}
                  >
                    Order Customer
                  </Button>
                </Col>
              </Row>
            </Space>
          </Col>

          {/* Right Column - Cart & Calculator (Desktop Only) */}
          <Col xs={0} lg={8}>
            <Space direction="vertical" size={16} style={{ width: '100%' }}>
              {/* Cart Section */}
              <Card
                style={{
                  height: 300,
                }}
                bodyStyle={{
                  height: 'calc(100% - 57px)',
                  padding: 0,
                  overflowY: 'auto',
                }}
              >
                <Table
                  dataSource={cart}
                  columns={desktopColumns}
                  rowKey="id"
                  pagination={false}
                  locale={{ emptyText: 'No items in cart' }}
                  size="small"
                />
              </Card>

              {/* Calculator & Billing */}
              <Row gutter={12}>
                <Col span={13}>
                  <CalculatorComponent />
                </Col>
                <Col span={11}>
                  <BillingSummary />
                </Col>
              </Row>
            </Space>
          </Col>
        </Row>
      </div>

      {/* Mobile Cart Drawer */}
      <Drawer
        title={
          <Space size="small">
            <Title level={4} style={{ margin: 0 }}>Cart</Title>
            <Tag color="blue">{cart.length} items</Tag>
          </Space>
        }
        placement="right"
        onClose={() => setCartDrawerVisible(false)}
        open={cartDrawerVisible}
        width="100%"
        bodyStyle={{ padding: 0 }}
      >
        <Flex vertical style={{ height: '100%' }}>
          <div style={{ flex: 1, overflow: 'auto' }}>
            <Table
              dataSource={cart}
              columns={mobileColumns}
              rowKey="id"
              pagination={false}
              locale={{ emptyText: 'No items in cart' }}
              size="middle"
            />
          </div>

          <div style={{ padding: 16, background: colorBgContainer, borderTop: '1px solid #f0f0f0' }}>
            <Space direction="vertical" size={16} style={{ width: '100%' }}>
              <CalculatorComponent isModal={true} />
              <BillingSummary isModal={true} />
            </Space>
          </div>
        </Flex>
      </Drawer>

     
    </>
  );
};

export default Dashboard;